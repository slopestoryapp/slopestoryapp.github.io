<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <!--
    GitHub Pages can't set HTTP response headers, so we use a meta CSP as a best-effort hardening.
    For stronger protection (HSTS, X-Frame-Options, etc), proxy app.slopestory.com through a layer
    that can set headers (e.g. Cloudflare).
  -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; base-uri 'none'; form-action 'none'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src https://rnudbfdhrenesamdjzdk.supabase.co https://cdn.jsdelivr.net; img-src 'self' data: https://rnudbfdhrenesamdjzdk.supabase.co https://res.cloudinary.com; font-src 'self' data:;">
  <title>Admin Dashboard - SlopeStory</title>
  <link rel="icon" type="image/png" href="https://rnudbfdhrenesamdjzdk.supabase.co/storage/v1/object/public/brand-assets/logo-light.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #4298D2;
      --primary-light: #6DB5DE;
      --primary-dark: #3a87be;
      --slate-light: #35506A;
      --slate-mid: #213A50;
      --slate-dark: #101E2A;
      --slate-darker: #0a1219;
      --surface: #1a2d3d;
      --surface-hover: #243a4d;
      --border: #2d4356;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --success: #22c55e;
      --success-bg: rgba(34, 197, 94, 0.1);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.1);
      --error: #ef4444;
      --error-bg: rgba(239, 68, 68, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--slate-darker);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Loading & Auth Screens */
    .screen-center {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--slate-dark) 0%, var(--slate-darker) 100%);
    }

    .auth-logo { height: 48px; margin-bottom: 24px; }
    .auth-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .auth-subtitle { color: var(--text-secondary); margin-bottom: 32px; }

    .auth-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 380px;
    }

    .auth-box input {
      width: 100%;
      padding: 14px 16px;
      background: var(--slate-dark);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 15px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }

    .auth-box input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .auth-box input::placeholder { color: var(--text-muted); }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .btn:hover { background: var(--primary-dark); }
    .btn:disabled { background: var(--text-muted); cursor: not-allowed; }
    .btn-secondary { background: var(--surface); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--surface-hover); }
    .btn-success { background: var(--success); }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: var(--error); }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 10px 16px; font-size: 13px; width: auto; }
    .btn-icon { padding: 10px; width: auto; }

    .auth-error {
      background: var(--error-bg);
      color: var(--error);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 12px;
      display: none;
    }

    /* Dashboard Layout */
    .dashboard { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--slate-dark);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-logo { height: 32px; }
    .sidebar-title { font-size: 18px; font-weight: 600; }
    .sidebar-badge {
      background: var(--primary);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      margin-left: auto;
    }

    .sidebar-nav { flex: 1; padding: 16px 12px; }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      margin-bottom: 4px;
    }

    .nav-item:hover { background: var(--surface); color: var(--text-primary); }
    .nav-item.active { background: var(--primary); color: white; }
    .nav-item svg { width: 20px; height: 20px; opacity: 0.8; }
    .nav-item.active svg { opacity: 1; }

    .nav-badge {
      margin-left: auto;
      background: var(--error);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--surface);
      border-radius: 10px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .user-details { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: var(--text-muted); }

    .btn-logout {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .btn-logout:hover { background: var(--error-bg); color: var(--error); }

    /* Main Content */
    .main { flex: 1; margin-left: 260px; }

    .main-header {
      background: var(--slate-dark);
      border-bottom: 1px solid var(--border);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .page-title { font-size: 20px; font-weight: 600; }
    .page-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

    .main-content { padding: 32px; }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title svg { width: 20px; height: 20px; color: var(--primary); }
    .card-body { padding: 24px; }
    .card-body-flush { padding: 0; }

    /* Grid */
    .grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }

    @media (max-width: 1200px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }

    /* Stats */
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
    .stat-value { font-size: 28px; font-weight: 700; }
    .stat-change { font-size: 12px; color: var(--success); margin-top: 4px; }

    /* Submissions List */
    .submission-list { max-height: 400px; overflow-y: auto; }

    .submission-item {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .submission-item:last-child { border-bottom: none; }
    .submission-item:hover { background: var(--surface-hover); }
    .submission-item.active { background: var(--primary); background: rgba(66, 152, 210, 0.15); border-left: 3px solid var(--primary); }

    .submission-name { font-weight: 600; margin-bottom: 4px; }
    .submission-meta { font-size: 13px; color: var(--text-muted); display: flex; gap: 16px; }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-pending { background: var(--warning-bg); color: var(--warning); }
    .status-approved { background: var(--success-bg); color: var(--success); }
    .status-rejected { background: var(--error-bg); color: var(--error); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }

    .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state p { font-size: 14px; }

    /* Form Elements */
    .form-group { margin-bottom: 20px; }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-label span { color: var(--error); }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--slate-dark);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-input::placeholder { color: var(--text-muted); }
    .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }

    /* Research Prompt */
    .prompt-display {
      background: var(--slate-darker);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      font-family: 'SF Mono', Monaco, 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-secondary);
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .prompt-display strong { color: var(--primary-light); }

    .copy-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--success);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .copy-status.show { opacity: 1; }

    /* Process Result */
    .result-box {
      padding: 16px 20px;
      border-radius: 10px;
      margin-top: 16px;
    }

    .result-box.success { background: var(--success-bg); border: 1px solid var(--success); }
    .result-box.error { background: var(--error-bg); border: 1px solid var(--error); }

    .result-url {
      background: var(--slate-darker);
      padding: 12px 16px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      margin-top: 12px;
      word-break: break-all;
    }

    /* Workflow Steps */
    .workflow-steps { display: flex; flex-direction: column; gap: 12px; }

    .workflow-step {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px;
      background: var(--slate-dark);
      border-radius: 10px;
      transition: all 0.2s;
    }

    .workflow-step:hover { background: var(--surface-hover); }

    .step-number {
      width: 28px;
      height: 28px;
      background: var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .step-number.active { background: var(--primary); }
    .step-number.complete { background: var(--success); }

    .step-content { flex: 1; }
    .step-title { font-weight: 500; margin-bottom: 4px; }
    .step-desc { font-size: 13px; color: var(--text-muted); }

    /* Action Buttons Row */
    .action-row {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--slate-dark);
      border-radius: 10px;
      margin-bottom: 24px;
    }

    .tab {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab:hover { color: var(--text-primary); }
    .tab.active { background: var(--primary); color: white; }

    /* Submission Details Panel */
    .detail-panel {
      background: var(--slate-dark);
      border-radius: 12px;
      padding: 24px;
    }

    .detail-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .detail-title { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
    .detail-subtitle { color: var(--text-muted); font-size: 14px; }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .detail-item label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-item p {
      font-size: 15px;
      margin-top: 4px;
    }

    .detail-image {
      margin-top: 24px;
      border-radius: 12px;
      overflow: hidden;
      background: var(--slate-darker);
    }

    .detail-image img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--slate-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Hide elements */
    .hidden { display: none !important; }

    /* Support Ticket Styles */
    .filter-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .filter-row select {
      padding: 10px 14px;
      background: var(--slate-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      min-width: 140px;
    }

    .filter-row select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .category-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    .category-resort_info { background: rgba(66, 152, 210, 0.15); color: #6DB5DE; }
    .category-missing_resort { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
    .category-bug { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .category-feature { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .category-account { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .category-other { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }

    .status-in_progress { background: rgba(66, 152, 210, 0.15); color: var(--primary); }
    .status-resolved { background: var(--success-bg); color: var(--success); }
    .status-closed { background: rgba(100, 116, 139, 0.15); color: #94a3b8; }

    .ticket-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .ticket-item:last-child { border-bottom: none; }
    .ticket-item:hover { background: var(--surface-hover); }
    .ticket-item.active { background: rgba(66, 152, 210, 0.15); border-left: 3px solid var(--primary); }

    .ticket-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .ticket-subject {
      font-weight: 500;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ticket-preview {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 8px;
    }

    .ticket-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .ticket-list { max-height: 500px; overflow-y: auto; }

    .message-box {
      background: var(--slate-darker);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-secondary);
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .status-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-actions .btn-sm {
      flex: 1;
      min-width: 100px;
    }

    /* Loading spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Refresh button */
    .btn-refresh {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .btn-refresh:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-refresh svg {
      width: 16px;
      height: 16px;
    }

    .btn-refresh.loading svg {
      animation: spin 0.8s linear infinite;
    }

    /* Roadmap */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 16px;
    }

    .roadmap-branch {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .roadmap-branch-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: rgba(66, 152, 210, 0.12);
      border-bottom: 1px solid var(--border);
    }

    .roadmap-branch-title {
      font-weight: 700;
      font-size: 15px;
      color: var(--primary-light);
    }

    .roadmap-branch-actions { display: flex; gap: 8px; }
    .roadmap-feature-list { padding: 12px; }
    .roadmap-feature-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 6px;
      background: var(--slate-dark);
    }

    .roadmap-feature-row:hover { background: var(--surface-hover); }
    .roadmap-feature-name { flex: 1; min-width: 0; }
    .roadmap-feature-name input {
      width: 100%;
      background: var(--slate-darker);
      border: 1px solid transparent;
      color: var(--text-primary);
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    .roadmap-feature-name input:hover,
    .roadmap-feature-name input:focus {
      border-color: var(--border);
      outline: none;
    }
    .roadmap-feature-status { width: 140px; }
    .roadmap-feature-status select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      background: var(--slate-darker);
      color: var(--text-primary);
      border: 1px solid var(--border);
      font-size: 13px;
      cursor: pointer;
    }
    .roadmap-empty { color: var(--text-muted); padding: 16px; font-size: 14px; }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="screen-center">
    <img src="https://rnudbfdhrenesamdjzdk.supabase.co/storage/v1/object/public/brand-assets/logo-light.png" alt="SlopeStory" class="auth-logo">
    <div class="spinner"></div>
  </div>

  <!-- Auth Screen -->
  <div id="authScreen" class="screen-center hidden">
    <img src="https://rnudbfdhrenesamdjzdk.supabase.co/storage/v1/object/public/brand-assets/logo-light.png" alt="SlopeStory" class="auth-logo">
    <h1 class="auth-title">Admin Dashboard</h1>
    <p class="auth-subtitle">Sign in to manage SlopeStory</p>
    <div class="auth-box">
      <input type="email" id="authEmail" placeholder="Email address">
      <input type="password" id="authPassword" placeholder="Password">
      <button class="btn" onclick="signIn()">Sign In</button>
      <div id="authError" class="auth-error"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="https://rnudbfdhrenesamdjzdk.supabase.co/storage/v1/object/public/brand-assets/logo-light.png" alt="" class="sidebar-logo">
        <span class="sidebar-title">SlopeStory</span>
        <span class="sidebar-badge">ADMIN</span>
      </div>

      <nav class="sidebar-nav">
        <a class="nav-item active" data-page="submissions">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
          Resort Submissions
          <span class="nav-badge" id="pendingCount">0</span>
        </a>
        <a class="nav-item" data-page="feature-photos">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          Feature Photos
          <span class="nav-badge" id="featurePhotosPendingCount">0</span>
        </a>
        <a class="nav-item" data-page="resorts">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          Resorts
        </a>
        <a class="nav-item" data-page="users">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          Users
        </a>
        <a class="nav-item" data-page="support">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          Support
          <span class="nav-badge" id="supportPendingCount">0</span>
        </a>
        <a class="nav-item" data-page="roadmap">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
          Roadmap
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-details">
            <div class="user-name" id="userEmail">admin@slopestory.com</div>
            <div class="user-role">Administrator</div>
          </div>
          <button class="btn-logout" onclick="signOut()" title="Sign out">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <header class="main-header">
        <div>
          <h1 class="page-title">Resort Submissions</h1>
          <p class="page-subtitle">Review and process new resort requests</p>
        </div>
        <button class="btn-refresh" onclick="loadSubmissions()" id="refreshBtn">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Refresh
        </button>
      </header>

      <div class="main-content" id="submissionsPage">
        <!-- Stats Row -->
        <div class="grid grid-3" style="margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-label">Pending Review</div>
            <div class="stat-value" id="statPending">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Approved This Month</div>
            <div class="stat-value" id="statApproved">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Resorts</div>
            <div class="stat-value" id="statTotal">-</div>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Submissions List -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                Pending Submissions
              </h2>
            </div>
            <div class="card-body-flush">
              <div class="submission-list" id="submissionList">
                <div class="empty-state">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m6 4.125l2.25 2.25m0 0l2.25 2.25M12 13.875l2.25-2.25M12 13.875l-2.25 2.25M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/></svg>
                  <p>Loading submissions...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Selected Submission Details -->
          <div class="card" id="detailsCard">
            <div class="card-header">
              <h2 class="card-title">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Submission Details
              </h2>
            </div>
            <div class="card-body" id="detailsBody">
              <div class="empty-state">
                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/></svg>
                <p>Select a submission to view details</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Processing Section -->
        <div class="card" style="margin-top: 24px;" id="processingCard">
          <div class="card-header">
            <h2 class="card-title">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              Process Resort
            </h2>
          </div>
          <div class="card-body">
            <div class="tabs">
              <button class="tab active" data-tab="workflow">Workflow</button>
              <button class="tab" data-tab="research">Research Prompt</button>
              <button class="tab" data-tab="image">Process Image</button>
            </div>

            <!-- Workflow Tab -->
            <div id="tabWorkflow" class="tab-content">
              <div class="workflow-steps">
                <div class="workflow-step">
                  <div class="step-number" id="step1">1</div>
                  <div class="step-content">
                    <div class="step-title">Select a submission above</div>
                    <div class="step-desc">Click on a pending submission to load its details</div>
                  </div>
                </div>
                <div class="workflow-step">
                  <div class="step-number" id="step2">2</div>
                  <div class="step-content">
                    <div class="step-title">Copy Research Prompt</div>
                    <div class="step-desc">Go to Research Prompt tab, copy, and paste to Claude to get resort JSON data</div>
                  </div>
                </div>
                <div class="workflow-step">
                  <div class="step-number" id="step3">3</div>
                  <div class="step-content">
                    <div class="step-title">Process Image</div>
                    <div class="step-desc">Go to Process Image tab to upload and optimize the resort cover image</div>
                  </div>
                </div>
                <div class="workflow-step">
                  <div class="step-number" id="step4">4</div>
                  <div class="step-content">
                    <div class="step-title">Insert Resort Data</div>
                    <div class="step-desc">Ask Claude Code to verify JSON and generate INSERT SQL, then run in Supabase</div>
                  </div>
                </div>
                <div class="workflow-step">
                  <div class="step-number" id="step5">5</div>
                  <div class="step-content">
                    <div class="step-title">Approve or Reject</div>
                    <div class="step-desc">Update submission status - approved sends email notification to user</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Research Prompt Tab -->
            <div id="tabResearch" class="tab-content hidden">
              <div class="form-group">
                <label class="form-label">Resort Name</label>
                <input type="text" class="form-input" id="promptResortName" placeholder="Resort name will auto-fill from selection">
              </div>
              <div class="form-group">
                <label class="form-label">Country</label>
                <input type="text" class="form-input" id="promptCountry" placeholder="Country will auto-fill from selection">
              </div>
              <div class="form-group">
                <label class="form-label">Generated Prompt</label>
                <div class="prompt-display" id="promptDisplay">Select a submission or enter resort details above to generate the research prompt.</div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px; margin-top: 16px;">
                <button class="btn btn-sm" onclick="copyPrompt()">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                  Copy Prompt
                </button>
                <span class="copy-status" id="copyStatus">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                  Copied!
                </span>
              </div>
            </div>

            <!-- Process Image Tab -->
            <div id="tabImage" class="tab-content hidden">
              <div class="form-group">
                <label class="form-label">Submission ID</label>
                <input type="text" class="form-input" id="imageSubmissionId" placeholder="Auto-filled from selected submission">
                <p class="form-hint">Leave empty to use Photo URL instead</p>
              </div>
              <div class="form-group">
                <label class="form-label">Photo URL (alternative)</label>
                <input type="text" class="form-input" id="imagePhotoUrl" placeholder="https://...">
              </div>
              <div class="form-group">
                <label class="form-label">Resort Name <span>*</span></label>
                <input type="text" class="form-input" id="imageResortName" placeholder="Official resort name for filename">
                <p class="form-hint">Use the official name from Claude's JSON response</p>
              </div>
              <button class="btn" onclick="processImage()" id="processImageBtn">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Process Image
              </button>
              <div id="imageResult"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Feature Photos Page Content -->
      <div id="featurePhotosPage" class="main-content hidden">
        <div class="grid grid-3" style="margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-label">Pending Review</div>
            <div class="stat-value" id="featurePhotosStatPending">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Approved This Month</div>
            <div class="stat-value" id="featurePhotosStatApproved">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Submissions</div>
            <div class="stat-value" id="featurePhotosStatTotal">-</div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Pending Feature Photos
              </h2>
              <button class="btn-refresh" onclick="loadFeaturePhotos()" id="featurePhotosRefreshBtn">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
              </button>
            </div>
            <div class="card-body-flush">
              <div class="submission-list" id="featurePhotoList">
                <div class="empty-state">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m6 4.125l2.25 2.25m0 0l2.25 2.25M12 13.875l2.25-2.25M12 13.875l-2.25 2.25M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/></svg>
                  <p>Loading...</p>
                </div>
              </div>
            </div>
          </div>

          <div class="card" id="featurePhotoDetailsCard">
            <div class="card-header">
              <h2 class="card-title">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Submission Details
              </h2>
            </div>
            <div class="card-body" id="featurePhotoDetailsBody">
              <div class="empty-state">
                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/></svg>
                <p>Select a submission to view details and approve or reject</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Roadmap Page Content -->
      <div id="roadmapPage" class="main-content hidden">
        <div id="roadmapMsg" class="result-box" style="display: none; margin-bottom: 16px;"></div>
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 24px; flex-wrap: wrap;">
          <button class="btn btn-sm" onclick="roadmapAddBranch()">+ Add branch</button>
          <button class="btn-refresh" onclick="loadRoadmap()" id="roadmapRefreshBtn">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Refresh
          </button>
        </div>
        <div id="roadmapTree"></div>

        <div id="roadmapModal" class="modal-backdrop" style="display: none;">
          <div class="card" style="max-width: 420px; width: 100%;">
            <div class="card-header">
              <h2 class="card-title" id="roadmapModalTitle">Add</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="roadmapModalName" placeholder="e.g. MAP & COLLECTION">
              </div>
              <div class="form-group" id="roadmapModalStatusWrap" style="display: none;">
                <label class="form-label">Status</label>
                <select class="form-select" id="roadmapModalStatus">
                  <option value="exploring">Exploring</option>
                  <option value="planned">Planned</option>
                  <option value="dusted">Dusted</option>
                  <option value="in_progress">In Progress</option>
                  <option value="done">Done</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Sort order</label>
                <input type="number" class="form-input" id="roadmapModalSort" value="0" min="0">
              </div>
              <div class="action-row">
                <button class="btn btn-secondary btn-sm" onclick="roadmapModalClose()">Cancel</button>
                <button class="btn btn-sm" onclick="roadmapModalSave()">Save</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Support Page Content -->
      <div id="supportPage" class="main-content hidden">
        <!-- Stats Row -->
        <div class="grid grid-3" style="margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-label">Pending</div>
            <div class="stat-value" id="supportStatPending">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">In Progress</div>
            <div class="stat-value" id="supportStatInProgress">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Resolved This Month</div>
            <div class="stat-value" id="supportStatResolved">-</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filter-row">
          <select id="filterCategory" onchange="filterSupportTickets()">
            <option value="">All Categories</option>
            <option value="resort_info">Resort Info</option>
            <option value="missing_resort">Missing Resort</option>
            <option value="bug">Bug Report</option>
            <option value="feature">Feature Request</option>
            <option value="account">Account Issue</option>
            <option value="other">Other</option>
          </select>
          <select id="filterStatus" onchange="filterSupportTickets()">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
          </select>
        </div>

        <div class="grid grid-2">
          <!-- Tickets List -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Support Tickets
              </h2>
              <span style="font-size: 13px; color: var(--text-muted);" id="ticketCount">0 tickets</span>
            </div>
            <div class="card-body-flush">
              <div class="ticket-list" id="ticketList">
                <div class="empty-state">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m6 4.125l2.25 2.25m0 0l2.25 2.25M12 13.875l2.25-2.25M12 13.875l-2.25 2.25M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/></svg>
                  <p>Loading tickets...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Ticket Details -->
          <div class="card" id="ticketDetailsCard">
            <div class="card-header">
              <h2 class="card-title">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Ticket Details
              </h2>
            </div>
            <div class="card-body" id="ticketDetailsBody">
              <div class="empty-state">
                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/></svg>
                <p>Select a ticket to view details</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ============ Configuration ============
    const SUPABASE_URL = 'https://rnudbfdhrenesamdjzdk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudWRiZmRocmVuZXNhbWRqemRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MjEwNTIsImV4cCI6MjA4NDE5NzA1Mn0.oxSYGKF5jkiTCWZblioMxYnKK8d-NGQkp5incBTYi3E';

    // IMPORTANT: This is only a UI gate.
    // Real security must be enforced by Supabase RLS + Edge Functions (server-side).
    const ADMIN_EMAILS = ['slopestoryapp@gmail.com', 'admin@slopestory.com'];

    // ============ Initialize Supabase ============
    let sb = null;
    try {
      if (window.supabase && window.supabase.createClient) {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch (e) {
      console.error('Failed to initialize Supabase:', e);
    }

    // Global image onerror (avoids nested quotes in inline handlers)
    window._imgLoadErr = function (el) {
      if (el && el.parentElement) {
        var p = document.createElement('p');
        p.style.cssText = 'padding:48px;text-align:center;color:var(--text-muted)';
        p.textContent = 'Image failed to load';
        el.parentElement.innerHTML = '';
        el.parentElement.appendChild(p);
      }
    };

    // ============ State ============
    let currentSubmission = null;
    let submissions = [];
    let currentPage = 'submissions';

    // Support state
    let supportTickets = [];
    let filteredTickets = [];
    let currentTicket = null;

    // Roadmap state
    let roadmapRows = [];
    let roadmapEditingId = null;
    let roadmapAddUnderParentId = null;

    // Feature photos state
    let featurePhotos = [];
    let currentFeaturePhoto = null;

    // ============ DOM Elements ============
    const $loadingScreen = document.getElementById('loadingScreen');
    const $authScreen = document.getElementById('authScreen');
    const $dashboard = document.getElementById('dashboard');
    const $authError = document.getElementById('authError');

    // ============ Auth Functions ============
    async function checkAuth() {
      if (!sb) {
        showAuthScreen();
        return;
      }

      try {
        const { data: { session }, error } = await sb.auth.getSession();

        if (error) {
          showAuthScreen();
          return;
        }

        if (session && ADMIN_EMAILS.includes(session.user.email.toLowerCase())) {
          showDashboard(session.user.email);
        } else if (session) {
          await sb.auth.signOut();
          showAuthScreen('Access denied. This account is not authorized.');
        } else {
          showAuthScreen();
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        showAuthScreen();
      }
    }

    function showAuthScreen(error = null) {
      $loadingScreen.classList.add('hidden');
      $authScreen.classList.remove('hidden');
      $dashboard.classList.add('hidden');

      if (error) {
        $authError.textContent = error;
        $authError.style.display = 'block';
      } else {
        $authError.style.display = 'none';
      }
    }

    function showDashboard(email) {
      $loadingScreen.classList.add('hidden');
      $authScreen.classList.add('hidden');
      $dashboard.classList.remove('hidden');

      document.getElementById('userEmail').textContent = email;
      document.getElementById('userAvatar').textContent = email.charAt(0).toUpperCase();

      loadSubmissions();
      loadStats();
      loadSupportTickets();
      loadSupportStats();
      loadFeaturePhotosCount();
    }

    // ============ Page Navigation ============
    function navigateToPage(page) {
      currentPage = page;

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      // Update header
      const header = document.querySelector('.main-header');
      const submissionsPage = document.getElementById('submissionsPage');
      const featurePhotosPage = document.getElementById('featurePhotosPage');
      const supportPage = document.getElementById('supportPage');
      const roadmapPage = document.getElementById('roadmapPage');
      const refreshBtn = document.getElementById('refreshBtn');

      const allPages = [submissionsPage, featurePhotosPage, supportPage, roadmapPage].filter(Boolean);
      allPages.forEach(p => p.classList.add('hidden'));

      if (page === 'roadmap') {
        header.querySelector('.page-title').textContent = 'Feature Roadmap';
        header.querySelector('.page-subtitle').textContent = 'Manage branches and features (app & waitlist)';
        roadmapPage.classList.remove('hidden');
        refreshBtn.onclick = loadRoadmap;
        loadRoadmap();
      } else if (page === 'support') {
        header.querySelector('.page-title').textContent = 'Support Tickets';
        header.querySelector('.page-subtitle').textContent = 'Manage user support requests and feedback';
        supportPage.classList.remove('hidden');
        refreshBtn.onclick = () => { loadSupportTickets(); loadSupportStats(); };
      } else if (page === 'feature-photos') {
        header.querySelector('.page-title').textContent = 'Feature Photos';
        header.querySelector('.page-subtitle').textContent = 'Approve or reject community photo submissions';
        featurePhotosPage.classList.remove('hidden');
        refreshBtn.onclick = loadFeaturePhotos;
        loadFeaturePhotos();
      } else if (page === 'submissions') {
        header.querySelector('.page-title').textContent = 'Resort Submissions';
        header.querySelector('.page-subtitle').textContent = 'Review and process new resort requests';
        submissionsPage.classList.remove('hidden');
        refreshBtn.onclick = loadSubmissions;
      } else {
        // Placeholder for other pages
        header.querySelector('.page-title').textContent = capitalize(page);
        header.querySelector('.page-subtitle').textContent = 'Coming soon...';
        if (submissionsPage) submissionsPage.classList.remove('hidden');
      }
    }

    // Setup nav click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.dataset.page;
        if (page) navigateToPage(page);
      });
    });

    async function signIn() {
      if (!sb) {
        $authError.textContent = 'Service unavailable. Please refresh.';
        $authError.style.display = 'block';
        return;
      }

      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;

      if (!email || !password) {
        $authError.textContent = 'Please enter email and password';
        $authError.style.display = 'block';
        return;
      }

      if (!ADMIN_EMAILS.includes(email.toLowerCase())) {
        $authError.textContent = 'Access denied. Not authorized.';
        $authError.style.display = 'block';
        return;
      }

      $authError.style.display = 'none';

      const { data, error } = await sb.auth.signInWithPassword({ email, password });

      if (error) {
        $authError.textContent = error.message;
        $authError.style.display = 'block';
      } else {
        showDashboard(data.user.email);
      }
    }

    async function signOut() {
      if (sb) await sb.auth.signOut();
      showAuthScreen();
    }

    // ============ Data Functions ============
    async function loadSubmissions() {
      if (!sb) return;

      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.classList.add('loading');

      try {
        const { data, error } = await sb
          .from('resort_submissions')
          .select('*')
          .eq('status', 'pending')
          .order('submitted_at', { ascending: false });

        if (error) throw error;

        submissions = data || [];
        renderSubmissions();
        document.getElementById('pendingCount').textContent = submissions.length;
        document.getElementById('statPending').textContent = submissions.length;
      } catch (err) {
        console.error('Failed to load submissions:', err);
        document.getElementById('submissionList').innerHTML = `
          <div class="empty-state">
            <p>Failed to load submissions. Check console for errors.</p>
          </div>
        `;
      }

      refreshBtn.classList.remove('loading');
    }

    async function loadStats() {
      if (!sb) return;

      try {
        // Get total resorts
        const { count: totalResorts } = await sb
          .from('resorts')
          .select('*', { count: 'exact', head: true });

        document.getElementById('statTotal').textContent = totalResorts || 0;

        // Get approved count (no date filter since we don't have updated_at)
        const { count: approvedCount } = await sb
          .from('resort_submissions')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'approved');

        document.getElementById('statApproved').textContent = approvedCount || 0;
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    // ============ Support Ticket Functions ============
    async function loadSupportTickets() {
      if (!sb) return;

      try {
        const { data, error } = await sb
          .from('support_requests')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        supportTickets = data || [];
        filterSupportTickets();

        // Update pending badge
        const pendingCount = supportTickets.filter(t => t.status === 'pending').length;
        document.getElementById('supportPendingCount').textContent = pendingCount;
      } catch (err) {
        console.error('Failed to load support tickets:', err);
        document.getElementById('ticketList').innerHTML = `
          <div class="empty-state">
            <p>Failed to load tickets. Check console for errors.</p>
          </div>
        `;
      }
    }

    async function loadSupportStats() {
      if (!sb) return;

      try {
        const pending = supportTickets.filter(t => t.status === 'pending').length;
        const inProgress = supportTickets.filter(t => t.status === 'in_progress').length;

        // Get resolved this month
        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        startOfMonth.setHours(0, 0, 0, 0);

        const resolved = supportTickets.filter(t =>
          t.status === 'resolved' && new Date(t.updated_at) >= startOfMonth
        ).length;

        document.getElementById('supportStatPending').textContent = pending;
        document.getElementById('supportStatInProgress').textContent = inProgress;
        document.getElementById('supportStatResolved').textContent = resolved;
      } catch (err) {
        console.error('Failed to load support stats:', err);
      }
    }

    function filterSupportTickets() {
      const category = document.getElementById('filterCategory').value;
      const status = document.getElementById('filterStatus').value;

      filteredTickets = supportTickets.filter(ticket => {
        if (category && ticket.category !== category) return false;
        if (status && ticket.status !== status) return false;
        return true;
      });

      renderSupportTickets();
    }

    function renderSupportTickets() {
      const list = document.getElementById('ticketList');
      document.getElementById('ticketCount').textContent = `${filteredTickets.length} ticket${filteredTickets.length !== 1 ? 's' : ''}`;

      if (filteredTickets.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p>No tickets found</p>
          </div>
        `;
        return;
      }

      list.innerHTML = filteredTickets.map(ticket => `
        <div class="ticket-item ${currentTicket?.id === ticket.id ? 'active' : ''}" onclick="selectTicket('${ticket.id}')">
          <div class="ticket-header">
            <span class="category-badge category-${ticket.category}">${getCategoryIcon(ticket.category)} ${getCategoryLabel(ticket.category)}</span>
            <span class="status-badge status-${ticket.status}">${getStatusLabel(ticket.status)}</span>
          </div>
          <div class="ticket-subject">${escapeHtml(getTicketSubject(ticket))}</div>
          <div class="ticket-preview">${escapeHtml(ticket.message || '').substring(0, 80)}${(ticket.message || '').length > 80 ? '...' : ''}</div>
          <div class="ticket-meta">
            <span>${formatDate(ticket.created_at)}</span>
            ${ticket.resort_name ? `<span> ${escapeHtml(ticket.resort_name)}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    function selectTicket(id) {
      currentTicket = supportTickets.find(t => t.id === id);
      renderSupportTickets();
      renderTicketDetails();
    }

    function renderTicketDetails() {
      const body = document.getElementById('ticketDetailsBody');

      if (!currentTicket) {
        body.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/></svg>
            <p>Select a ticket to view details</p>
          </div>
        `;
        return;
      }

      const t = currentTicket;
      body.innerHTML = `
        <div class="detail-panel">
          <div class="detail-header">
            <div>
              <div class="detail-title">${escapeHtml(getTicketSubject(t))}</div>
              <div class="detail-subtitle">
                <span class="category-badge category-${t.category}" style="margin-right: 8px;">${getCategoryIcon(t.category)} ${getCategoryLabel(t.category)}</span>
                <span class="status-badge status-${t.status}">${getStatusLabel(t.status)}</span>
              </div>
            </div>
          </div>

          <div class="detail-grid" style="margin-bottom: 20px;">
            <div class="detail-item">
              <label>Ticket ID</label>
              <p style="font-family: monospace; font-size: 11px;">${t.id}</p>
            </div>
            <div class="detail-item">
              <label>Created</label>
              <p>${formatDate(t.created_at)}</p>
            </div>
            <div class="detail-item">
              <label>User ID</label>
              <p style="font-family: monospace; font-size: 11px;">${t.user_id || 'Anonymous'}</p>
            </div>
            <div class="detail-item">
              <label>Last Updated</label>
              <p>${formatDate(t.updated_at)}</p>
            </div>
            ${t.resort_name ? `
              <div class="detail-item">
                <label>Resort Name</label>
                <p>${escapeHtml(t.resort_name)}</p>
              </div>
            ` : ''}
            ${t.resort_id ? `
              <div class="detail-item">
                <label>Resort ID</label>
                <p style="font-family: monospace; font-size: 11px;">${t.resort_id}</p>
              </div>
            ` : ''}
            ${t.screen_feature ? `
              <div class="detail-item">
                <label>Screen/Feature</label>
                <p>${escapeHtml(t.screen_feature)}</p>
              </div>
            ` : ''}
            ${t.feature_title ? `
              <div class="detail-item">
                <label>Feature Title</label>
                <p>${escapeHtml(t.feature_title)}</p>
              </div>
            ` : ''}
            ${t.issue_type ? `
              <div class="detail-item">
                <label>Issue Type</label>
                <p>${escapeHtml(t.issue_type)}</p>
              </div>
            ` : ''}
          </div>

          <div class="form-group">
            <label class="form-label">Message</label>
            <div class="message-box">${escapeHtml(t.message || 'No message provided')}</div>
          </div>

          ${t.steps_to_reproduce ? `
            <div class="form-group">
              <label class="form-label">Steps to Reproduce</label>
              <div class="message-box">${escapeHtml(t.steps_to_reproduce)}</div>
            </div>
          ` : ''}

          ${t.why_useful ? `
            <div class="form-group">
              <label class="form-label">Why Useful</label>
              <div class="message-box">${escapeHtml(t.why_useful)}</div>
            </div>
          ` : ''}

          ${t.device_info ? `
            <div class="form-group">
              <label class="form-label">Device Info</label>
              <div class="message-box">${JSON.stringify(t.device_info, null, 2)}</div>
            </div>
          ` : ''}

          <div class="action-row">
            <div class="status-actions">
              ${t.status !== 'in_progress' ? `
                <button class="btn btn-sm" onclick="updateTicketStatus('in_progress')">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  In Progress
                </button>
              ` : ''}
              ${t.status !== 'resolved' ? `
                <button class="btn btn-success btn-sm" onclick="updateTicketStatus('resolved')">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                  Resolved
                </button>
              ` : ''}
              ${t.status !== 'closed' ? `
                <button class="btn btn-secondary btn-sm" onclick="updateTicketStatus('closed')">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                  Close
                </button>
              ` : ''}
              ${t.status !== 'pending' ? `
                <button class="btn btn-secondary btn-sm" onclick="updateTicketStatus('pending')">
                  Reopen
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    async function updateTicketStatus(newStatus) {
      if (!currentTicket || !sb) return;

      try {
        const { error } = await sb
          .from('support_requests')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', currentTicket.id);

        if (error) throw error;

        // Update local state
        currentTicket.status = newStatus;
        currentTicket.updated_at = new Date().toISOString();
        const idx = supportTickets.findIndex(t => t.id === currentTicket.id);
        if (idx !== -1) supportTickets[idx] = currentTicket;

        filterSupportTickets();
        renderTicketDetails();
        loadSupportStats();

        // Update nav badge
        const pendingCount = supportTickets.filter(t => t.status === 'pending').length;
        document.getElementById('supportPendingCount').textContent = pendingCount;
      } catch (err) {
        console.error('Failed to update ticket status:', err);
        alert('Failed to update status: ' + err.message);
      }
    }

    // Support helper functions
    function getCategoryIcon(category) {
      const icons = {
        resort_info: '',
        missing_resort: '',
        bug: '',
        feature: '',
        account: '',
        other: ''
      };
      return icons[category] || '';
    }

    function getCategoryLabel(category) {
      const labels = {
        resort_info: 'Resort Info',
        missing_resort: 'Missing Resort',
        bug: 'Bug Report',
        feature: 'Feature Request',
        account: 'Account',
        other: 'Other'
      };
      return labels[category] || category;
    }

    function getStatusLabel(status) {
      const labels = {
        pending: 'Pending',
        in_progress: 'In Progress',
        resolved: 'Resolved',
        closed: 'Closed'
      };
      return labels[status] || status;
    }

    // ============ Feature Photos ============
    async function loadFeaturePhotosCount() {
      if (!sb) return;
      try {
        const { count, error } = await sb
          .from('resort_feature_photo_submissions')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'pending');
        if (error) return;
        document.getElementById('featurePhotosPendingCount').textContent = count || 0;
      } catch (err) {
        console.error('Feature photos count failed:', err);
      }
    }

    async function loadFeaturePhotos() {
      if (!sb) return;

      const refreshBtn = document.getElementById('featurePhotosRefreshBtn');
      if (refreshBtn) refreshBtn.classList.add('loading');

      const listEl = document.getElementById('featurePhotoList');
      listEl.innerHTML = '<div class="empty-state"><div class="spinner" style="margin: 0 auto 12px;"></div><p>Loading...</p></div>';

      try {
        const { data: pending, error: pendingErr } = await sb
          .from('resort_feature_photo_submissions')
          .select('*, resort:resorts(name)')
          .eq('status', 'pending')
          .order('created_at', { ascending: false });

        if (pendingErr) throw pendingErr;

        const { count: totalCount, error: totalErr } = await sb
          .from('resort_feature_photo_submissions')
          .select('*', { count: 'exact', head: true });
        if (!totalErr) {
          document.getElementById('featurePhotosStatTotal').textContent = totalCount ?? 0;
        }

        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        startOfMonth.setHours(0, 0, 0, 0);
        const { data: approvedThisMonth, error: approvedErr } = await sb
          .from('resort_feature_photo_submissions')
          .select('id')
          .eq('status', 'approved')
          .gte('reviewed_at', startOfMonth.toISOString());
        if (!approvedErr) {
          document.getElementById('featurePhotosStatApproved').textContent = (approvedThisMonth || []).length;
        }

        featurePhotos = pending || [];
        document.getElementById('featurePhotosStatPending').textContent = featurePhotos.length;
        document.getElementById('featurePhotosPendingCount').textContent = featurePhotos.length;

        renderFeaturePhotoList();
        if (currentFeaturePhoto && !featurePhotos.find(f => f.id === currentFeaturePhoto.id)) {
          currentFeaturePhoto = null;
        }
        renderFeaturePhotoDetails();
      } catch (err) {
        console.error('Failed to load feature photos:', err);
        listEl.innerHTML = '<div class="empty-state"><p>Failed to load. Check console.</p></div>';
      }

      if (refreshBtn) refreshBtn.classList.remove('loading');
    }

    function renderFeaturePhotoList() {
      const list = document.getElementById('featurePhotoList');

      if (featurePhotos.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p>No pending feature photo submissions</p>
          </div>
        `;
        return;
      }

      list.innerHTML = featurePhotos.map(fp => {
        const resortName = (fp.resort && fp.resort.name) || 'Unknown resort';
        return `
        <div class="submission-item ${currentFeaturePhoto?.id === fp.id ? 'active' : ''}" onclick="selectFeaturePhoto('${fp.id}')">
          <div class="submission-name">${escapeHtml(resortName)}</div>
          <div class="submission-meta">
            <span>${formatDate(fp.created_at)}</span>
          </div>
        </div>
      `;
      }).join('');
    }

    function selectFeaturePhoto(id) {
      currentFeaturePhoto = featurePhotos.find(f => f.id === id);
      renderFeaturePhotoList();
      renderFeaturePhotoDetails();
    }

    function renderFeaturePhotoDetails() {
      const body = document.getElementById('featurePhotoDetailsBody');

      if (!currentFeaturePhoto) {
        body.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/></svg>
            <p>Select a submission to view details and approve or reject</p>
          </div>
        `;
        return;
      }

      const fp = currentFeaturePhoto;
      const resortName = (fp.resort && fp.resort.name) || 'Unknown resort';

      body.innerHTML = `
        <div class="detail-panel">
          <div class="detail-header">
            <div>
              <div class="detail-title">${escapeHtml(resortName)}</div>
              <div class="detail-subtitle">${formatDate(fp.created_at)}</div>
            </div>
            <span class="status-badge status-pending">Pending</span>
          </div>

          <div class="detail-grid">
            <div class="detail-item">
              <label>Submission ID</label>
              <p style="font-family: monospace; font-size: 11px;">${fp.id}</p>
            </div>
            <div class="detail-item">
              <label>User ID</label>
              <p style="font-family: monospace; font-size: 11px;">${fp.user_id || '-'}</p>
            </div>
            <div class="detail-item">
              <label>Resort ID</label>
              <p style="font-family: monospace; font-size: 11px;">${fp.resort_id}</p>
            </div>
            ${fp.caption ? `
            <div class="detail-item" style="grid-column: 1 / -1;">
              <label>Caption</label>
              <p>${escapeHtml(fp.caption)}</p>
            </div>
            ` : ''}
          </div>

          <div class="detail-image">
            <img src="${fp.photo_url}" alt="Submitted photo" onerror="window._imgLoadErr(this)">
          </div>

          <div class="action-row">
            <button class="btn btn-success btn-sm" onclick="updateFeaturePhotoStatus('approved')">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
              Approve
            </button>
            <button class="btn btn-danger btn-sm" onclick="updateFeaturePhotoStatus('rejected')">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              Reject
            </button>
          </div>
        </div>
      `;
    }

    async function updateFeaturePhotoStatus(status) {
      if (!currentFeaturePhoto || !sb) return;
      if (!confirm("Are you sure you want to " + status + " this submission? Approved photos will appear in the resort's community gallery and may set the resort cover if none exists.")) return;

      try {
        const { error } = await sb
          .from('resort_feature_photo_submissions')
          .update({ status })
          .eq('id', currentFeaturePhoto.id);

        if (error) throw error;

        alert('Submission ' + status + ' successfully.');
        currentFeaturePhoto = null;
        loadFeaturePhotos();
        loadFeaturePhotosCount();
      } catch (err) {
        console.error('Failed to update feature photo status:', err);
        alert('Failed to update: ' + err.message);
      }
    }

    // ============ Roadmap ============
    function roadmapMsg(text, isError) {
      const el = document.getElementById('roadmapMsg');
      el.textContent = text;
      el.className = 'result-box ' + (isError ? 'error' : 'success');
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }

    async function loadRoadmap() {
      if (!sb) return;
      const treeEl = document.getElementById('roadmapTree');
      const refreshBtn = document.getElementById('roadmapRefreshBtn');
      if (refreshBtn) refreshBtn.classList.add('loading');
      treeEl.innerHTML = '<div class="empty-state"><div class="spinner" style="margin: 0 auto 12px;"></div><p>Loading roadmap</p></div>';
      try {
        const { data, error } = await sb.from('app_features').select('id, parent_id, name, node_type, status, sort_order').order('sort_order').order('name');
        if (error) throw error;
        roadmapRows = data || [];
        buildRoadmapTree();
      } catch (err) {
        console.error('Roadmap load failed:', err);
        treeEl.innerHTML = '<div class="result-box error">' + escapeHtml(err.message) + '</div>';
      }
      if (refreshBtn) refreshBtn.classList.remove('loading');
    }

    function buildRoadmapTree() {
      const treeEl = document.getElementById('roadmapTree');
      const branches = roadmapRows.filter(r => r.node_type === 'branch' && !r.parent_id)
        .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0) || (a.name || '').localeCompare(b.name || ''));
      const byParent = {};
      roadmapRows.forEach(r => {
        const pid = r.parent_id || 'root';
        if (!byParent[pid]) byParent[pid] = [];
        byParent[pid].push(r);
      });
      byParent.root = branches;
      branches.forEach(b => {
        (byParent[b.id] || []).sort((x, y) => (x.sort_order || 0) - (y.sort_order || 0) || (x.name || '').localeCompare(y.name || ''));
      });

      let html = '';
      branches.forEach(branch => {
        const children = (byParent[branch.id] || []).filter(r => r.node_type === 'feature');
        html += '<div class="roadmap-branch" data-branch-id="' + branch.id + '">';
        html += '<div class="roadmap-branch-header">';
        html += '<span class="roadmap-branch-title">' + escapeHtml(branch.name) + '</span>';
        html += '<div class="roadmap-branch-actions">';
        html += '<button type="button" class="btn btn-secondary btn-sm" onclick="roadmapAddFeature(\'' + branch.id + '\')">+ Feature</button>';
        html += '<button type="button" class="btn btn-secondary btn-sm" data-id="' + escapeAttr(branch.id) + '" data-name="' + escapeAttr(branch.name) + '" data-sort="' + (branch.sort_order || 0) + '" onclick="roadmapEditBranch(this)">Edit</button>';
        html += '<button type="button" class="btn btn-danger btn-sm" data-id="' + escapeAttr(branch.id) + '" data-name="' + escapeAttr(branch.name) + '" onclick="roadmapDelete(this)">Delete</button>';
        html += '</div></div>';
        html += '<div class="roadmap-feature-list">';
        if (children.length === 0) {
          html += '<div class="roadmap-empty">No features. Click "+ Feature" to add one.</div>';
        } else {
          children.forEach(f => {
            html += '<div class="roadmap-feature-row" data-id="' + f.id + '">';
            html += '<div class="roadmap-feature-name"><input type="text" value="' + escapeAttr(f.name) + '" data-id="' + f.id + '" onblur="roadmapFeatureNameBlur(\'' + f.id + '\', this.value.trim())"></div>';
            html += '<div class="roadmap-feature-status"><select data-id="' + f.id + '" onchange="roadmapFeatureStatusChange(\'' + f.id + '\', this.value)">';
            ['exploring', 'planned', 'dusted', 'in_progress', 'done'].forEach(opt => {
              html += '<option value="' + opt + '"' + (f.status === opt ? ' selected' : '') + '>' + (opt === 'in_progress' ? 'In Progress' : opt.charAt(0).toUpperCase() + opt.slice(1)) + '</option>';
            });
            html += '</select></div>';
            html += '<button type="button" class="btn btn-danger btn-sm" data-id="' + escapeAttr(f.id) + '" data-name="' + escapeAttr(f.name) + '" onclick="roadmapDelete(this)">Delete</button>';
            html += '</div>';
          });
        }
        html += '</div></div>';
      });
      if (branches.length === 0) html = '<div class="roadmap-empty">No branches yet. Click "+ Add branch" to create one.</div>';
      treeEl.innerHTML = html;
    }

    function escapeAttr(s) {
      if (!s) return '';
      return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function roadmapAddBranch() {
      roadmapEditingId = null;
      roadmapAddUnderParentId = null;
      document.getElementById('roadmapModalTitle').textContent = 'Add branch';
      document.getElementById('roadmapModalName').value = '';
      document.getElementById('roadmapModalName').placeholder = 'e.g. MAP & COLLECTION';
      document.getElementById('roadmapModalStatusWrap').style.display = 'none';
      document.getElementById('roadmapModalSort').value = '0';
      document.getElementById('roadmapModal').style.display = 'flex';
    }

    function roadmapAddFeature(parentId) {
      roadmapEditingId = null;
      roadmapAddUnderParentId = parentId;
      document.getElementById('roadmapModalTitle').textContent = 'Add feature';
      document.getElementById('roadmapModalName').value = '';
      document.getElementById('roadmapModalName').placeholder = 'e.g. World map with resort pins';
      document.getElementById('roadmapModalStatusWrap').style.display = 'block';
      document.getElementById('roadmapModalStatus').value = 'exploring';
      document.getElementById('roadmapModalSort').value = '0';
      document.getElementById('roadmapModal').style.display = 'flex';
    }

    function roadmapEditBranch(btn) {
      roadmapEditingId = btn.dataset.id;
      roadmapAddUnderParentId = null;
      document.getElementById('roadmapModalTitle').textContent = 'Edit branch';
      document.getElementById('roadmapModalName').value = (btn.dataset.name || '').replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
      document.getElementById('roadmapModalStatusWrap').style.display = 'none';
      document.getElementById('roadmapModalSort').value = String(btn.dataset.sort || 0);
      document.getElementById('roadmapModal').style.display = 'flex';
    }

    function roadmapModalClose() {
      document.getElementById('roadmapModal').style.display = 'none';
    }

    async function roadmapModalSave() {
      const name = document.getElementById('roadmapModalName').value.trim();
      if (!name) { roadmapMsg('Name is required', true); return; }
      if (!sb) { roadmapMsg('Not connected', true); return; }
      const sort = parseInt(document.getElementById('roadmapModalSort').value, 10) || 0;

      try {
        if (roadmapEditingId) {
          const { error } = await sb.from('app_features').update({ name, sort_order: sort, updated_at: new Date().toISOString() }).eq('id', roadmapEditingId);
          if (error) throw error;
          roadmapMsg('Updated');
        } else if (roadmapAddUnderParentId) {
          const status = document.getElementById('roadmapModalStatus').value;
          const { error } = await sb.from('app_features').insert({ parent_id: roadmapAddUnderParentId, name, node_type: 'feature', status, sort_order: sort });
          if (error) throw error;
          roadmapMsg('Feature added');
        } else {
          const { error } = await sb.from('app_features').insert({ parent_id: null, name, node_type: 'branch', status: null, sort_order: sort });
          if (error) throw error;
          roadmapMsg('Branch added');
        }
        roadmapModalClose();
        loadRoadmap();
      } catch (err) {
        roadmapMsg(err.message, true);
      }
    }

    async function roadmapFeatureNameBlur(id, value) {
      if (!value || !sb) return;
      try {
        const { error } = await sb.from('app_features').update({ name: value, updated_at: new Date().toISOString() }).eq('id', id);
        if (error) throw error;
      } catch (err) {
        roadmapMsg(err.message, true);
      }
    }

    async function roadmapFeatureStatusChange(id, status) {
      if (!sb) return;
      try {
        const { error } = await sb.from('app_features').update({ status, updated_at: new Date().toISOString() }).eq('id', id);
        if (error) throw error;
        roadmapMsg('Status updated');
      } catch (err) {
        roadmapMsg(err.message, true);
      }
    }

    async function roadmapDelete(btn) {
      var id = btn.dataset.id;
      var name = (btn.dataset.name || '').replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&');
      var display = name || id;
      if (!confirm("Delete \"" + display + "\"? Deleting a branch will also remove all its features.")) return;
      if (!sb) return;
      try {
        const { error } = await sb.from('app_features').delete().eq('id', id);
        if (error) throw error;
        roadmapMsg('Deleted');
        loadRoadmap();
      } catch (err) {
        roadmapMsg(err.message, true);
      }
    }

    function getTicketSubject(ticket) {
      if (ticket.subject) return ticket.subject;
      if (ticket.feature_title) return ticket.feature_title;
      if (ticket.resort_name) return `${getCategoryLabel(ticket.category)}: ${ticket.resort_name}`;
      if (ticket.screen_feature) return `Bug in ${ticket.screen_feature}`;
      return getCategoryLabel(ticket.category);
    }

    function renderSubmissions() {
      const list = document.getElementById('submissionList');

      if (submissions.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p>No pending submissions</p>
          </div>
        `;
        return;
      }

      list.innerHTML = submissions.map(sub => `
        <div class="submission-item ${currentSubmission?.id === sub.id ? 'active' : ''}" onclick="selectSubmission('${sub.id}')">
          <div class="submission-name">${escapeHtml(sub.resort_name)}</div>
          <div class="submission-meta">
            <span>${escapeHtml(sub.country || 'Unknown')}</span>
            <span>${formatDate(sub.submitted_at)}</span>
          </div>
        </div>
      `).join('');
    }

    function selectSubmission(id) {
      currentSubmission = submissions.find(s => s.id === id);
      renderSubmissions();
      renderDetails();
      populateProcessingFields();
      updateWorkflowSteps();
    }

    function renderDetails() {
      const body = document.getElementById('detailsBody');

      if (!currentSubmission) {
        body.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/></svg>
            <p>Select a submission to view details</p>
          </div>
        `;
        return;
      }

      const sub = currentSubmission;
      body.innerHTML = `
        <div class="detail-panel">
          <div class="detail-header">
            <div>
              <div class="detail-title">${escapeHtml(sub.resort_name)}</div>
              <div class="detail-subtitle">${escapeHtml(sub.country || 'Country not specified')}</div>
            </div>
            <span class="status-badge status-pending">Pending</span>
          </div>

          <div class="detail-grid">
            <div class="detail-item">
              <label>Submission ID</label>
              <p style="font-family: monospace; font-size: 12px;">${sub.id}</p>
            </div>
            <div class="detail-item">
              <label>Submitted</label>
              <p>${formatDate(sub.submitted_at)}</p>
            </div>
            <div class="detail-item">
              <label>Submitter</label>
              <p style="font-family: monospace; font-size: 12px;">${sub.submitted_by || 'Anonymous'}</p>
            </div>
            <div class="detail-item">
              <label>Email</label>
              <p>${escapeHtml(sub.submitter_email) || 'Not provided'}</p>
            </div>
            <div class="detail-item">
              <label>Region</label>
              <p>${escapeHtml(sub.region) || 'Not specified'}</p>
            </div>
            <div class="detail-item">
              <label>Notes</label>
              <p>${escapeHtml(sub.notes) || 'None'}</p>
            </div>
          </div>

          ${sub.photo_url ? `
            <div class="detail-image">
              <img src="${sub.photo_url}" alt="Submitted photo" onerror="window._imgLoadErr(this)">
            </div>
          ` : ''}

          <div class="action-row">
            <button class="btn btn-success btn-sm" onclick="updateStatus('approved')">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
              Approve
            </button>
            <button class="btn btn-danger btn-sm" onclick="updateStatus('rejected')">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              Reject
            </button>
          </div>
        </div>
      `;
    }

    function populateProcessingFields() {
      if (!currentSubmission) return;

      document.getElementById('promptResortName').value = currentSubmission.resort_name || '';
      document.getElementById('promptCountry').value = currentSubmission.country || '';
      document.getElementById('imageSubmissionId').value = currentSubmission.id || '';
      document.getElementById('imageResortName').value = currentSubmission.resort_name || '';

      updatePrompt();
    }

    function updateWorkflowSteps() {
      const step1 = document.getElementById('step1');
      if (currentSubmission) {
        step1.classList.add('complete');
      } else {
        step1.classList.remove('complete');
      }
    }

    async function updateStatus(status) {
      if (!currentSubmission || !sb) return;

      if (!confirm(`Are you sure you want to ${status} this submission?`)) return;

      try {
        const { error } = await sb
          .from('resort_submissions')
          .update({ status })
          .eq('id', currentSubmission.id);

        if (error) throw error;

        alert(`Submission ${status} successfully!`);
        currentSubmission = null;
        loadSubmissions();
        renderDetails();
      } catch (err) {
        console.error('Failed to update status:', err);
        alert('Failed to update status: ' + err.message);
      }
    }

    // ============ Tabs ============
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

        tab.classList.add('active');
        document.getElementById('tab' + capitalize(tab.dataset.tab)).classList.remove('hidden');
      });
    });

    // ============ Research Prompt ============
    document.getElementById('promptResortName').addEventListener('input', updatePrompt);
    document.getElementById('promptCountry').addEventListener('input', updatePrompt);

    function updatePrompt() {
      const resortName = document.getElementById('promptResortName').value || '[RESORT NAME]';
      const country = document.getElementById('promptCountry').value || '[COUNTRY]';

      const prompt = `Research the following ski resort and provide accurate, verified data:

<strong>Resort Name:</strong> ${escapeHtml(resortName)}
<strong>Country:</strong> ${escapeHtml(country)}

<strong>Data Required</strong>
Provide the following information. Use NULL if data cannot be found.

<strong>Basic Info</strong>
- Official Name, Country, Country Code (ISO 3166-1 alpha-2)
- Region/State/Province, Official Website URL

<strong>Coordinates</strong>
- Latitude & Longitude (decimal degrees, 4+ decimal places)

<strong>Mountain Stats</strong>
- Vertical Drop (meters), Number of Runs, Number of Lifts
- Annual Snowfall (centimeters)

<strong>Terrain Breakdown</strong> (must total 100%)
- Beginner %, Intermediate %, Advanced/Expert %

<strong>Season & Features</strong>
- Season Open/Close months, Night Skiing (Yes/No)
- Pass Affiliation (Ikon, Epic, Mountain Collective, Indy Pass, or NULL)

<strong>Social Media</strong>
- Instagram Handle (official resort account, without @)

<strong>Description</strong>
- Write 1-2 engaging sentences about what makes this resort unique or special
- Focus on: record-breaking stats, famous events hosted, unique terrain features, or interesting history

<strong>Output as JSON:</strong>
{
  "name": "", "country": "", "country_code": "", "region": "",
  "lat": 0.0000, "lng": 0.0000, "website": "",
  "vertical_m": null, "runs": null, "lifts": null,
  "annual_snowfall_cm": null, "beginner_pct": null,
  "intermediate_pct": null, "advanced_pct": null,
  "pass_affiliation": null, "season_open": null,
  "season_close": null, "has_night_skiing": null,
  "instagram_handle": null,
  "description": null,
  "verified": false
}`;

      document.getElementById('promptDisplay').innerHTML = prompt;
    }

    function getPromptText() {
      const resortName = document.getElementById('promptResortName').value || '[RESORT NAME]';
      const country = document.getElementById('promptCountry').value || '[COUNTRY]';

      return `Research the following ski resort and provide accurate, verified data:

**Resort Name:** ${resortName}
**Country:** ${country}

## Data Required
Provide the following information. Use NULL if data cannot be found or verified.

### Basic Info
- Official Name (exact name as used by the resort)
- Country
- Country Code (ISO 3166-1 alpha-2, e.g., US, CA, FR, JP)
- Region/State/Province
- Official Website (full URL)

### Coordinates
- Latitude (decimal degrees, e.g., 46.8523)
- Longitude (decimal degrees, e.g., -121.7603)

### Mountain Stats
- Vertical Drop (meters)
- Number of Runs/Trails
- Number of Lifts
- Annual Snowfall (centimeters)

### Terrain Breakdown (must total 100%)
- Beginner %
- Intermediate %
- Advanced/Expert %

### Season & Features
- Typical Season Open (month)
- Typical Season Close (month)
- Night Skiing (Yes/No)
- Pass Affiliation (Ikon, Epic, Mountain Collective, Indy Pass, or NULL)

### Social Media
- Instagram Handle (official resort account, without @)

### Description
- Write 1-2 engaging sentences about what makes this resort unique
- Focus on: record-breaking stats, famous events, unique terrain, or interesting history

## Research Sources (priority order)
1. Resort's official website
2. Skiresort.info
3. OnTheSnow.com
4. Wikipedia

## Output Format
Return as JSON ready for database insertion:

{
  "name": "",
  "country": "",
  "country_code": "",
  "region": "",
  "lat": 0.0000,
  "lng": 0.0000,
  "website": "",
  "vertical_m": null,
  "runs": null,
  "lifts": null,
  "annual_snowfall_cm": null,
  "beginner_pct": null,
  "intermediate_pct": null,
  "advanced_pct": null,
  "pass_affiliation": null,
  "season_open": null,
  "season_close": null,
  "has_night_skiing": null,
  "instagram_handle": null,
  "description": null,
  "verified": false
}

## Important
- Convert all measurements to metric
- Coordinates must be precise (4+ decimal places)
- Terrain percentages must total 100%`;
    }

    function copyPrompt() {
      const text = getPromptText();
      navigator.clipboard.writeText(text).then(() => {
        const status = document.getElementById('copyStatus');
        status.classList.add('show');
        setTimeout(() => status.classList.remove('show'), 2000);
      }).catch(() => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        const status = document.getElementById('copyStatus');
        status.classList.add('show');
        setTimeout(() => status.classList.remove('show'), 2000);
      });
    }

    // ============ Process Image ============
    async function processImage() {
      const btn = document.getElementById('processImageBtn');
      const result = document.getElementById('imageResult');
      const submissionId = document.getElementById('imageSubmissionId').value.trim();
      const photoUrl = document.getElementById('imagePhotoUrl').value.trim();
      const resortName = document.getElementById('imageResortName').value.trim();

      if (!resortName) {
        result.innerHTML = '<div class="result-box error">Resort name is required</div>';
        return;
      }

      if (!submissionId && !photoUrl) {
        result.innerHTML = '<div class="result-box error">Either Submission ID or Photo URL is required</div>';
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Processing...';
      result.innerHTML = '';

      try {
        const body = { resort_name: resortName };
        // Prefer photo_url if provided, otherwise use submission_id
        if (photoUrl) {
          body.photo_url = photoUrl;
        } else if (submissionId) {
          body.submission_id = submissionId;
        }

        // Get fresh session
        const { data: { session }, error: sessionError } = await sb.auth.getSession();

        if (sessionError || !session?.access_token) {
          result.innerHTML = '<div class="result-box error">Session expired. Please sign out and sign back in.</div>';
          btn.disabled = false;
          btn.innerHTML = `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> Process Image`;
          return;
        }

        const response = await fetch(SUPABASE_URL + '/functions/v1/process-resort-image', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (data.success) {
          result.innerHTML = `
            <div class="result-box success">
              <strong>Image processed successfully!</strong><br>
              <span style="color: var(--text-secondary);">Compression: ${data.compressionRatio}</span>
              ${data.submissionUpdated ? '<br><span style="color: var(--success);"> Submission photo_url updated</span>' : ''}
              <div style="margin-top: 16px; border-radius: 8px; overflow: hidden; background: var(--slate-darker);">
                <img src="${data.url}" alt="Processed image" style="width: 100%; height: 200px; object-fit: cover;" onerror="window._imgLoadErr(this)">
              </div>
              <div class="result-url" style="margin-top: 12px;">${data.url}</div>
              <button class="btn btn-sm btn-secondary" style="margin-top: 12px;" onclick="navigator.clipboard.writeText('${data.url}'); this.textContent='Copied!'">
                Copy URL
              </button>
            </div>
          `;
        } else {
          result.innerHTML = `<div class="result-box error"><strong>Error:</strong> ${JSON.stringify(data)}</div>`;
        }
      } catch (e) {
        result.innerHTML = `<div class="result-box error"><strong>Error:</strong> ${e.message}</div>`;
      }

      btn.disabled = false;
      btn.innerHTML = `
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        Process Image
      `;
    }

    // ============ Utilities ============
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // ============ Initialize ============
    const authTimeout = setTimeout(() => showAuthScreen(), 3000);
    checkAuth().finally(() => clearTimeout(authTimeout));

    document.getElementById('authPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signIn();
    });

    if (sb) {
      sb.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) {
          if (ADMIN_EMAILS.includes(session.user.email.toLowerCase())) {
            showDashboard(session.user.email);
          } else {
            sb.auth.signOut();
            showAuthScreen('Access denied. Not authorized.');
          }
        }
      });
    }
  </script>
</body>
</html>
